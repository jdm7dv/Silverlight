<html dir="ltr" xmlns:MSHelp="http://msdn.microsoft.com/mshelp" xmlns:dt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882" xmlns:xlink="http://www.w3.org/1999/xlink">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <meta name="save" content="history" />
    <xml>
      <MSHelp:TOCTitle Title="Exercise 3: Adding Sessions to the Schedule" />
      <MSHelp:RLTitle Title="Exercise 3: Adding Sessions to the Schedule" />
      <MSHelp:Attr Name="DocSet" Value="docSet" />
      <MSHelp:Attr Name="TopicType" Value="kbOrient" />
      <MSHelp:Attr Name="Locale" Value="kbEnglish" />
      <MSHelp:Attr Name="AssetId" Value="{GUID}" />
    </xml>
    <title>Exercise 3: Adding Sessions to the Schedule</title>
    <link rel="stylesheet" type="text/css" href="../local/Classic.css" />
    <script src="../local/EventUtilities.js" type="text/javascript" language="jscript"> </script>
    <script src="../local/SplitScreen.js" type="text/javascript" language="jscript"> </script>
    <script src="../local/Dropdown.js" type="text/javascript" language="jscript"> </script>
    <script src="../local/script.js" type="text/javascript" language="jscript"> </script>
  </head>
  <body>
    <input type="hidden" id="userDataCache" class="userDataStyle" />
    <input type="hidden" id="hiddenScrollOffset" />
    <img id="dropDownImage" style="display:none; height:0; width:0;" alt="DropDown image" src="../local/drpdown.gif" />
    <img id="dropDownHoverImage" style="display:none; height:0; width:0;" alt="DropDownHover image" src="../local/drpdown_orange.gif" />
    <img id="collapseImage" style="display:none; height:0; width:0;" alt="Collapse image" src="../local/collapse_all.gif" />
    <img id="expandImage" style="display:none; height:0; width:0;" alt="Expand image" src="../local/expand_all.gif" />
    <img id="collapseAllImage" style="display:none; height:0; width:0;" alt="CollapseAll image" src="../local/collall.gif" />
    <img id="expandAllImage" style="display:none; height:0; width:0;" alt="ExpandAll image" src="../local/expall.gif" />
    <img id="copyImage" style="display:none; height:0; width:0;" alt="Copy image" src="../local/copycode.gif" />
    <img id="copyHoverImage" style="display:none; height:0; width:0;" alt="CopyHover image" src="../local/copycodeHighlight.gif" />
    <div id="header">
      <table width="100%" id="topTable">
        <tr id="headerTableRow1">
          <td align="left">
            <span id="runningHeaderText">Silverlight Business Apps: Module 5 - DataGrid, Grouping, Right Mouse Click Lab</span>
          </td>
        </tr>
        <tr id="headerTableRow2">
          <td align="left">
            <span id="nsrTitle">Exercise 3: Adding Sessions to the Schedule</span>
          </td>
        </tr>
        <tr id="headerTableRow3">
          <td />
        </tr>
      </table>
      <table width="100%" id="bottomTable" cellspacing="0" cellpadding="0">
        <tr>
          <td>
            <span onclick="ExpandCollapseAll(toggleAllImage)" onkeypress="ExpandCollapseAll_CheckKey(toggleAllImage)" tabindex="0" style="cursor:default;display:none;">
              <img id="toggleAllImage" class="toggleAll" alt="CollapseAll image" src="../local/collall.gif" />
              <label id="collapseAllLabel" for="toggleAllImage" style="display: none;">Collapse All</label>
              <label id="expandAllLabel" for="toggleAllImage" style="display: none;">Expand All</label> </span>
            <span id="languageFilterToolTip" onmouseover="languageFilterImage.src=dropDownHoverImage.src;" onmouseout="languageFilterImage.src=dropDownImage.src;" tabindex="0" style="cursor:default;">
              <img id="languageFilterImage" alt="DropDown image" src="../local/drpdown.gif" />
              <label id="showAllLabel" for="languageFilterImage" style="display: none;">Language Filter: All</label>
              <label id="multipleLabel" for="languageFilterImage" style="display: none;">Language Filter: Multiple</label>
              <label id="vbLabel" for="languageFilterImage" style="display: none;">Language Filter: Visual Basic</label>
              <label id="csLabel" for="languageFilterImage" style="display: none;">Language Filter: C#</label>
            </span>
          </td>
        </tr>
      </table>
      <div id="languageSpan">
        <input type="checkbox" name="languageFilter" onclick="SetLanguage(this)" id="vbUsageCheckbox" />
        <label class="languageFilter" for="vbUsageCheckbox">Visual Basic Usage</label>
        <br />
        <input type="checkbox" name="languageFilter" onclick="SetLanguage(this)" id="csCheckbox" />
        <label class="languageFilter" for="csCheckbox">C#</label>
        <br />
      </div>
    </div>
    <div id="mainSection">
      <div id="mainBody">
        <div id="allHistory" class="saveHistory" onsave="saveAll()" onload="loadAll()" />
        <p>The schedule planner won’t be much use if all it can do is show an existing plan. Users need to be able to add talks to their planned schedule. So in this part, you’ll add the code to make that happen. You’ll also see how some new visual states added in Silverlight 4 make it possible to run animations as new items are added.</p>
        <a name="_Toc256193985" href="#">
          <span />
        </a>
        <p>
          <b>Add Sessions to a Schedule</b>
        </p>
        <ol>
          <li>In the SchedulePlannerViewModel class, add the following command:<div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>private RelayCommand _addTalkCommand;public ICommand AddTalkCommand { get { return _addTalkCommand; } }private void OnAddTalk(){}</pre></td></tr></table></span></div></li>
          <li>Add the following using statement, if it is not already there:<div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>using System.Windows.Input;</pre></td></tr></table></span></div></li>
          <li>Add a constructor to create the command object and wire it into that method:<div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>public SchedulePlannerViewModel(){    _addTalkCommand = new RelayCommand(OnAddTalk);}</pre></td></tr></table></span></div><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>The button that we’ll wire to this command will need to be enabled or disabled based on whether a talk is currently selected in the data grid, and whether that talk is already in the user’s schedule. </td></tr></table><p /></div></li>
          <li>Add a property <b>SelectedTalkInFullList</b> that can be bound to the grid’s SelectedItem property and add code to update the command status as the selection changes:<div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>private Talk _selectedTalkInFullList;public Talk SelectedTalkInFullList{    get { return _selectedTalkInFullList; }    set    {        if (value != _selectedTalkInFullList)        {            _selectedTalkInFullList = value;            OnPropertyChanged("SelectedTalkInFullList");            UpdateCommandStatus();        }    }}private void UpdateCommandStatus(){    _addTalkCommand.IsEnabled = SelectedTalkInFullList != null &amp;&amp;     (SubscribedTalks == null ||      !SubscribedTalks.Any(talk =&gt; talk.TalkID == SelectedTalkInFullList.TalkID));}</pre></td></tr></table></span></div><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>Before we can implement the OnAddTalk method we need some server-side support. Again, we’re doing work that requires use of the Attendee entity representing the current user, something the client currently doesn’t have access to. While we could arrange for the client to get access to that, and have the client create new associated AttendeeScheduleTalk entities, it’s straightforward and efficient just to add a suitably specialized domain operation. </td></tr></table><p /></div></li>
          <li>Add this method to the EventDomainManagerService class in the Services folder of the SlEventManager.Web project:<div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>[Invoke]public void AddTalkToUserSchedule(int talkID){    Attendee attendee = GetOrCreateAttendeeForCurrentUser();    AttendeeScheduleTalk ast = new AttendeeScheduleTalk { TalkID = talkID };    attendee.AttendeeScheduleTalks.Add(ast);    this.ObjectContext.SaveChanges();}</pre></td></tr></table></span></div></li>
          <li>Add the following code to the OnAddTalk method in the <b>SchedulePlannerViewModel</b> class:<div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>private void OnAddTalk(){    // Take a copy because the update will happen asynchronously, so the    // SelectedTalkInFullList property could change before we're finished.    Talk talkToAdd = SelectedTalkInFullList;    if (talkToAdd != null)    {        _context.AddTalkToUserSchedule(talkToAdd.TalkID, addOp =&gt;        {            SubscribedTalks.Add(talkToAdd);            UpdateCommandStatus();        }, null);    }}</pre></td></tr></table></span></div><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>This not only calls the new method to add the talk to the schedule on the server side, it also updates the client-side list of subscribed talks. Since that list is an observable collection, Silverlight’s data binding will notice the change and update the items control.</td></tr></table><p /></div></li>
          <li>Add the following button to SchedulePlanner.xaml after the DataGrid, so we have a way to invoke the command:<div class="code"><span codeLanguage="other"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>XAML</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>&lt;Button    Content="&amp;gt;"    Grid.Column="1"    Margin="0,56,0,12"    Command="{Binding Path=AddTalkCommand}"    /&gt;</pre></td></tr></table></span></div></li>
          <li>In the DataGrid, add this attribute to connect its selected item to the corresponding property in the view model:<div class="code"><span codeLanguage="other"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>XAML</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>SelectedItem="{Binding Path=SelectedTalkInFullList, Mode=TwoWay}"</pre></td></tr></table></span></div></li>
          <li>Run the application.<div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>In the planner you should be able to add items to the right by selecting items on the left and clicking the button. Selecting items that are already in the schedule will cause the button to become disabled.</td></tr></table><p /></div></li>
          <li>Stop the application.</li>
        </ol>
        <a name="_Toc256193986" href="#">
          <span />
        </a>
        <p>
          <b>Adding Fluid UI Features (Optional)</b>
        </p>
        <p>For this part of the lab, we’ll use the new visual states in Silverlight 4 that are sometimes referred to as ‘fluid UI’ animations, enabling animations to run when items are added to and removed from a list. This is only available on ListBoxItems, so we need to be using a ListBox. </p>
        <ol>
          <li>In SchedulePlanner.xaml, find the nested ItemsControl. <div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>Not the one directly inside the ScrollViewer. Find that one’s ItemTemplate and in there is another ItemsControl.</td></tr></table><p /></div></li>
          <li>Change the <b>ItemsControl</b> into a ListBox. </li>
          <li>Also, change the ItemsControl.ItemTemplate element into a ListBox.ItemTemplate element. <div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>Silverlight doesn’t require this. It is happy for you to use the base class name. But Blend gets confused if you don’t.</td></tr></table><p /></div></li>
          <li>Add a ScrollViewer.HorizontalScrollBarVisibility="Disabled" attribute to the ListBox.</li>
          <li>Open the project in Expression Blend.</li>
          <li>Select the ItemsControl that shows the select talks. <div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>If you just click on the relevant item, you will probably end up selecting the containing ScrollViewer rather than the ItemsControl inside the ScrollViewer. Use the Objects and Timeline pane to ensure you’ve selected the ItemsControl.</td></tr></table><p /></div></li>
          <li>Using the ‘breadcrumb’ menu at the top left of the editor area, edit the generated items template for the control:<p><img src="images\cacaad66-e6c7-43c6-b505-467c3a39eb98.png" /></p><p><b>Figure 4</b><br /><i>Editing the Generated Items Template</i></p><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>Remember that this items control is showing grouped items, so the item template we’re editing right now represents a whole group. (The talks are grouped by time slot.) But we’ll want to run animations any time individual talks are added, rather than when a new group appears. </td></tr></table><p /></div></li>
          <li>Find and select the nested ListBox inside the template.</li>
          <li>From the Object menu, select Edit Additional Styles → Edit Generated Item Container (ItemContainerStyle) → Edit a Copy… </li>
          <li>Click OK in the Create Style Resource dialog. Then use the breadcrumb menus to edit the template for the item container as shown below<p><img src="images\9f31df59-b8df-4a9b-8ebb-986606d759a0.png" /></p><p><b>Figure 5</b><br /><i>Edit the Template</i></p></li>
          <li>In the Objects and Timeline pane, select the Grid inside the Template.</li>
          <li>In the Properties pane, set its Opacity to 0%.</li>
          <li>Open the States panel. </li>
          <li>With the Grid still selected, find the LayoutStates state group.</li>
          <li>Select the Loaded state. </li>
          <li>Set the opacity back up to 100%. </li>
          <li>In the Default transition row for the state group, change the duration from 0s to 0.5s.</li>
          <li>Run the application.</li>
          <li>Add a talk to the schedule. It should fade into place rather than appearing instantaneously.</li>
        </ol>
      </div>
      <div id="footer">
        <div class="footerLine">
          <img src="../local/footer.gif" alt="Footer image" width="100%" height="3px" />
        </div>To give feedback please write to jopapa@microsoft.com<p />Copyright © 2010 by Microsoft Corporation. All rights reserved.</div>
    </div>
  </body>
</html>